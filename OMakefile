.PHONY: all

USE_OCAMLFIND = true
NATIVE_ENABLED = true
BYTE_ENABLED = true

OCAMLFLAGS = -thread -principal -g -w @A-4-29-41-44-45 -bin-annot

mkdir -p _build
vmount(-l, src, _build)
vmount(-l, tests, _build)
# Make a seperate library for internal modules

OCAMLPACKS[] = xml-light async async_unix ocplib-endian

.SUBDIRS: _build
    section
        OCamlProgram(gen_spec, gen_spec)

        AMQP_SPEC_URL = http://www.rabbitmq.com/resources/specs/amqp0-9-1.stripped.extended.xml
        AMQP_SPEC = $(rootname $(basename $(AMQP_SPEC_URL)))
        $(AMQP_SPEC):
            mkdir -p data
            curl $(AMQP_SPEC_URL) > $@

        amqp_spec.ml: gen_spec $(AMQP_SPEC)
            ./gen_spec $(AMQP_SPEC) > $@

    section
	OCAMLFLAGS += -no-alias-deps
        #export OCAMLPACKS
        FILES[] =
            amqp_types
            amqp_spec
            amqp_framing
            amqp_constants
            amqp_util
            amqp_protocol
            amqp_channel
            amqp_connection
            amqp_queue
            amqp_rpc
            amqp_exchange
            amqp

        OCamlLibrary(ocaml-amqp, $(FILES))
    section
	OCAML_LINK_FLAGS = -linkpkg
	OCAML_LIBS += ocaml-amqp

	TESTS=$(rootname $(basename $(find ../tests/ -name *.ml)))

	foreach(x => ..., $(TESTS))
		OCamlProgram($(x), $(x))

	.DEFAULT: $(TESTS)

        .PHONY: integration

	TESTS=$(filter %_test, $(TESTS))
	integration: $(TESTS)
		foreach(test => ..., $(TESTS))
			echo "* Run test: $(test)"
			./$(test)
