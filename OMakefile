.PHONY: all

USE_OCAMLFIND = true
NATIVE_ENABLED = true
BYTE_ENABLED = false

OCAMLFLAGS = -thread -g -w @A-4-29-33-41-44-45-48 -bin-annot

OCAMLPACKS[] = xml-light async async_unix ocplib-endian

mkdir -p _build
vmount(-l, src, _build)

.SUBDIRS: _build
	OCamlProgram(gen_spec, gen_spec)

	#OCAMLFLAGS += -for-pack
	AMQP_SPEC_URL=http://www.rabbitmq.com/resources/specs/amqp0-9-1.stripped.extended.xml
	amqp0-9-1.stripped.xml:
		mkdir -p data
		curl $(AMQP_SPEC_URL) > $@

	FILES[] =
	    amqp_types
            amqp_spec
	    amqp_channel
            amqp_framing
            amqp_constants
            amqp_util
            amqp_protocol
            amqp_connection
            amqp_queue
            amqp_rpc
	    amqp_exchange
            amqp


	amqp_spec.ml: gen_spec amqp0-9-1.stripped.xml
		./gen_spec amqp0-9-1.stripped.xml > $@

	#OCamlPackage(plibamqp, $(FILES))
	OCamlLibrary(libamqp, $(FILES))


vmount(-l, tests, _build)
.SUBDIRS: _build
	OCAML_LINK_FLAGS = -linkpkg
	#OCAMLINCLUDES += ../_build
	OCAML_LIBS += libamqp

	OCamlProgram(main, main)
	OCamlProgram(rpc_server, rpc_server)
	OCamlProgram(rpc_client, rpc_client)
	OCamlProgram(channel, channel_test)
	OCamlProgram(queue, queue_test)
	OCamlProgram(exchange, exchange_test)

	.DEFAULT: main rpc_server rpc_client channel queue exchange
