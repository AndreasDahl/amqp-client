.PHONY: all

USE_OCAMLFIND = true
NATIVE_ENABLED = false
BYTE_ENABLED = true

OCAMLFLAGS = -thread -g -w @A-4-29-33-41-44-45-48 -bin-annot

OCAMLPACKS[] = batteries xml-light async async_unix ocplib-endian

vmount(-l, src, _build)
mkdir -p _build
.SUBDIRS: _build
    section:
	.DEFAULT: $(OCamlProgram gen_spec, gen_spec)

    section:
	AMQP_SPEC_URL=http://www.rabbitmq.com/resources/specs/amqp0-9-1.stripped.extended.xml
	amqp0-9-1.stripped.xml:
		mkdir -p data
		curl $(AMQP_SPEC_URL) > $@

	FILES[] =
	    amqp_types
            amqp_spec
	    amqp_channel
            amqp_framing
            amqp_constants
            amqp_util
            amqp_protocol
            amqp_connection
            amqp_queue
            amqp


	DATA_FILE=amqp0-9-1.stripped.xml
	amqp_spec.ml: gen_spec amqp0-9-1.stripped.xml
		./gen_spec amqp0-9-1.stripped.xml > $@

	.DEFAULT: $(OCamlProgram main, main $(FILES))
